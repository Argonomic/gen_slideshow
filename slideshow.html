
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JPG Slideshow with Audio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/addons/p5.sound.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
    <audio id="backgroundAudio"></audio>
    <script>
		     //               window.audioAPI.startPlayback(); // new

		const FAST_INTRO = false;
        const images = ["file://d:/depots/gen_slideshow/images/001 intro.jpg","file://d:/depots/gen_slideshow/images/002 black.jpg","file://d:/depots/gen_slideshow/images/1100 allie  (1).jpg","file://d:/depots/gen_slideshow/images/1100 allie  (2).jpg","file://d:/depots/gen_slideshow/images/1100 allie  (3).jpg","file://d:/depots/gen_slideshow/images/1110 august  (1).jpg","file://d:/depots/gen_slideshow/images/1110 august  (2).jpg","file://d:/depots/gen_slideshow/images/1110 august  (3).jpg","file://d:/depots/gen_slideshow/images/1120 charlie  (3).jpg","file://d:/depots/gen_slideshow/images/1120 charlie  (4).jpg","file://d:/depots/gen_slideshow/images/1120 charlie  (5).jpg","file://d:/depots/gen_slideshow/images/1130 dawson  (1).jpg","file://d:/depots/gen_slideshow/images/1130 dawson  (2).jpg","file://d:/depots/gen_slideshow/images/1130 dawson  (3).jpg","file://d:/depots/gen_slideshow/images/1140 elise 3 (1).jpg","file://d:/depots/gen_slideshow/images/1140 elise 3 (2).jpg","file://d:/depots/gen_slideshow/images/1140 elise 3 (3).jpg","file://d:/depots/gen_slideshow/images/1150 ella 3 (1).jpg","file://d:/depots/gen_slideshow/images/1150 ella 3 (2).jpg","file://d:/depots/gen_slideshow/images/1150 ella 3 (3).jpg","file://d:/depots/gen_slideshow/images/1160 flo 1.jpg","file://d:/depots/gen_slideshow/images/1160 flo 2.jpg","file://d:/depots/gen_slideshow/images/1160 flo 3.jpg","file://d:/depots/gen_slideshow/images/1170_george 1.jpg","file://d:/depots/gen_slideshow/images/1170_george 2.jpg","file://d:/depots/gen_slideshow/images/1170_george 3.jpg","file://d:/depots/gen_slideshow/images/1180 jack 1.jpg","file://d:/depots/gen_slideshow/images/1180 jack 2.jpg","file://d:/depots/gen_slideshow/images/1180 jack 3.jpg","file://d:/depots/gen_slideshow/images/1190 jaimin 1.jpg","file://d:/depots/gen_slideshow/images/1190 jaimin 2.jpg","file://d:/depots/gen_slideshow/images/1190 jaimin 3.jpg","file://d:/depots/gen_slideshow/images/1200 khushi 1.jpg","file://d:/depots/gen_slideshow/images/1200 khushi 2.jpg","file://d:/depots/gen_slideshow/images/1200 khushi 3.jpg","file://d:/depots/gen_slideshow/images/1210 kinsey 1.jpg","file://d:/depots/gen_slideshow/images/1210 kinsey 2.jpg","file://d:/depots/gen_slideshow/images/1210 kinsey 3.jpg","file://d:/depots/gen_slideshow/images/1220 lainey 1.jpg","file://d:/depots/gen_slideshow/images/1220 lainey 2.jpg","file://d:/depots/gen_slideshow/images/1220 lainey 3.jpg","file://d:/depots/gen_slideshow/images/1230 leo 1.jpg","file://d:/depots/gen_slideshow/images/1230 leo 2.jpg","file://d:/depots/gen_slideshow/images/1230 leo 3.jpg","file://d:/depots/gen_slideshow/images/1240 linly 1.jpg","file://d:/depots/gen_slideshow/images/1240 linly 2.jpg","file://d:/depots/gen_slideshow/images/1240 linly 3.jpg","file://d:/depots/gen_slideshow/images/1250 matilda 1.jpg","file://d:/depots/gen_slideshow/images/1250 matilda 2.jpg","file://d:/depots/gen_slideshow/images/1250 matilda 3.jpg","file://d:/depots/gen_slideshow/images/1260 naomi 1.jpg","file://d:/depots/gen_slideshow/images/1260 naomi 2.jpg","file://d:/depots/gen_slideshow/images/1260 naomi 3.jpg","file://d:/depots/gen_slideshow/images/1270 nicholas 1.jpg","file://d:/depots/gen_slideshow/images/1270 nicholas 2.jpg","file://d:/depots/gen_slideshow/images/1270 nicholas 3.jpg","file://d:/depots/gen_slideshow/images/1280 olu 1.jpg","file://d:/depots/gen_slideshow/images/1280 olu 2.jpg","file://d:/depots/gen_slideshow/images/1280 olu 3.jpg","file://d:/depots/gen_slideshow/images/1290 ryland 1.jpg","file://d:/depots/gen_slideshow/images/1290 ryland 2.jpg","file://d:/depots/gen_slideshow/images/1290 ryland 3.jpg","file://d:/depots/gen_slideshow/images/1300 spencer 1.jpg","file://d:/depots/gen_slideshow/images/1300 spencer 2.jpg","file://d:/depots/gen_slideshow/images/1300 spencer 3.jpg","file://d:/depots/gen_slideshow/images/1310 william 1.jpg","file://d:/depots/gen_slideshow/images/1310 william 2.jpg","file://d:/depots/gen_slideshow/images/1310 william 3.jpg","file://d:/depots/gen_slideshow/images/1999 transition.jpg","file://d:/depots/gen_slideshow/images/2005.jpg","file://d:/depots/gen_slideshow/images/2006.jpg","file://d:/depots/gen_slideshow/images/2033.jpg","file://d:/depots/gen_slideshow/images/2085.jpg","file://d:/depots/gen_slideshow/images/2090.jpg","file://d:/depots/gen_slideshow/images/2095.jpg","file://d:/depots/gen_slideshow/images/2125.jpg","file://d:/depots/gen_slideshow/images/2126.jpg","file://d:/depots/gen_slideshow/images/2128.jpg","file://d:/depots/gen_slideshow/images/2255.jpg","file://d:/depots/gen_slideshow/images/2270.jpg","file://d:/depots/gen_slideshow/images/2310.jpg","file://d:/depots/gen_slideshow/images/2315.jpg","file://d:/depots/gen_slideshow/images/2320.jpg","file://d:/depots/gen_slideshow/images/2321.jpg","file://d:/depots/gen_slideshow/images/2330.jpg","file://d:/depots/gen_slideshow/images/2333.jpg","file://d:/depots/gen_slideshow/images/2365.jpg","file://d:/depots/gen_slideshow/images/2380.jpg","file://d:/depots/gen_slideshow/images/2500.jpg","file://d:/depots/gen_slideshow/images/2525.jpg","file://d:/depots/gen_slideshow/images/2530.jpg","file://d:/depots/gen_slideshow/images/2633.jpg","file://d:/depots/gen_slideshow/images/2715.jpg","file://d:/depots/gen_slideshow/images/2716.jpg","file://d:/depots/gen_slideshow/images/2720.jpg","file://d:/depots/gen_slideshow/images/2730.jpg","file://d:/depots/gen_slideshow/images/2870.jpg","file://d:/depots/gen_slideshow/images/2925.jpg","file://d:/depots/gen_slideshow/images/2952 message.jpg","file://d:/depots/gen_slideshow/images/2953 black.jpg","file://d:/depots/gen_slideshow/images/2955 final.jpg"];
        const audioFiles = ["file://d:/depots/gen_slideshow/audio/001 TALK - Afraid of the Dark (Audio).mp3","file://d:/depots/gen_slideshow/audio/002 Randy Newman - You've Got a Friend in Me (From Toy Story 4Audio Only).mp3"]; // old
        const defaultFadeTime = 800;
        const defaultImageDuration = 1100;
        const finalFadeTime = 2000;
        const finalImageDuration = 6000;
        const finalPauseTime = 1000;
        const secondToLastFadeTime =  200;
		const OLD_AUDIO_ENABLED = false;
		const NEW_AUDIO_ENABLED = true;
        const secondToLastImageDuration =  200;
        const secondToLastPauseTime		   =  200;
        const scaleFactor = 1.05;
        let PANSPEED_SCALE = 1.5;
        let currentImage;
        let nextImage;
        let currentAudio;
        let currentIndex = 0;
        let audioIndex = 0;
        let currentAlpha = 0;
        let nextAlpha = 0;
        let phase = 'fadeIn';
        let lastSwitchTime = 0;
        let currentPanX = 0, currentPanY = 0, currentPanSpeedX = 0, currentPanSpeedY = 0, currentPanAngle = 0;
        let nextPanX = 0, nextPanY = 0, nextPanSpeedX = 0, nextPanSpeedY = 0, nextPanAngle = 0;
        let fadeTime = defaultFadeTime;
        let imageDuration = 2500; // initial image
		  console.log( "***1 imageDuration to " + imageDuration )
        let pauseTime = 0;
        let alphaStep = 255 / (fadeTime * 60 / 1000);
        let isFinalImage = false;
		  let isSecondToLastImage = false;

		  let isFirstImage = true;
        let isSlideshowActive = true;


		function preload() {
            if (images.length > 0) {
                currentImage = loadImage(images[0], 
                    () => console.log('Preload: Loaded image:', images[0]),
                    err => console.error('Preload: Error loading image:', images[0], err)
                );
                if (images.length > 1) {
                    nextImage = loadImage(images[1]);
                }
            }
            if (audioFiles.length > 0 && OLD_AUDIO_ENABLED) {
				console.log( "LEZZ PLAY DAT AUDIOSS" )
                currentAudio = loadSound(audioFiles[0], 
                    () => console.log('Preload: Loaded audio:', audioFiles[0]),
                    err => console.error('Preload: Error loading audio:', audioFiles[0], err)
                );
            }
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);
            console.log('Setup: Canvas created with dimensions:', windowWidth, 'x', windowHeight);
            background(0);
            setNewPanDirection('current');
            lastSwitchTime = millis();

            // Start audio playback
            if (audioFiles.length > 0) {
                playNextAudio();
            }
        }

        function playNextAudio() {
            if (!isSlideshowActive) return; // Stop audio playback if slideshow is done
            if (currentAudio) {
                currentAudio.stop(); // Stop any currently playing audio
            }
            currentAudio = loadSound(audioFiles[audioIndex], 
                () => {
                    if (isSlideshowActive && OLD_AUDIO_ENABLED) {
                        console.log('Playing audio:', audioFiles[audioIndex]);
                        currentAudio.play();
                        currentAudio.onended(() => {
                            audioIndex = (audioIndex + 1) % audioFiles.length;
                            playNextAudio(); // Play the next audio when this one ends
                        });
                    }
                },
                err => console.error('Error loading audio:', audioFiles[audioIndex], err)
            );
        }

        function draw() {
            background(0);
            let elapsed = millis() - lastSwitchTime;

            if (phase === 'fadeIn') {
                currentAlpha = min(currentAlpha + alphaStep, 255);
                if (elapsed >= fadeTime) {
                    currentAlpha = 255;
                    phase = 'display';
                }
            } else if (phase === 'display') {
                currentAlpha = 255;
                if (elapsed >= imageDuration) {
                    phase = 'crossfade';
                    if (isFinalImage) {
                        nextImage = null;
                    } else {
                        setNewPanDirection('next');
                    }
                }
            } else if (phase === 'crossfade') {
                currentAlpha = max(currentAlpha - alphaStep, 0);
                if (nextImage) {
                    nextAlpha = min(nextAlpha + alphaStep, 255 - currentAlpha);
                }
                if (currentAlpha <= 0) {
                    if (isFinalImage) {
                        phase = 'pause';
                    } else {
                        switchImage();
                        lastSwitchTime = millis();
                        phase = 'fadeIn';
                        currentAlpha = nextAlpha;
                        nextAlpha = 0;
                        currentPanX = nextPanX;
                        currentPanY = nextPanY;
                        currentPanSpeedX = nextPanSpeedX;
                        currentPanSpeedY = nextPanSpeedY;
                        currentPanAngle = nextPanAngle;
                    }
                }
            } else if (phase === 'pause') {
                if (elapsed >= imageDuration + fadeTime + pauseTime) {
                    console.log('Final image display complete. Stopping slideshow.');
                    isSlideshowActive = false;
                    if (currentAudio) {
                        currentAudio.stop();
                        console.log('Stopped audio at slideshow end');
                    }
                    window.electronAPI.closeWindow();
                    return;
                }
            }

            // Draw current image
            if (currentImage) {
                let imgRatio = currentImage.width / currentImage.height;
                let canvasRatio = width / height;
                let imgW, imgH;
                if (imgRatio > canvasRatio) {
                    imgH = height * scaleFactor;
                    imgW = imgH * imgRatio;
                } else {
                    imgW = width * scaleFactor;
                    imgH = imgW / imgRatio;
                }

                let maxPanX = (imgW - width) / 4;
                let maxPanY = (imgH - height) / 4;
                currentPanX += currentPanSpeedX;
                currentPanY += currentPanSpeedY;
					 // wip
               //  currentPanX = constrain(currentPanX, -maxPanX, maxPanX);
               //  currentPanY = constrain(currentPanY, -maxPanY, maxPanY); 

                let x = width / 2 + currentPanX;
                let y = height / 2 + currentPanY;

               //  console.log('Draw: currentPanX:', currentPanX, 'currentPanY:', currentPanY, 'currentPanSpeedX:', currentPanSpeedX, 'currentPanSpeedY:', currentPanSpeedY, 'maxPanX:', maxPanX, 'maxPanY:', maxPanY);

                push();
                translate(x, y);
                imageMode(CENTER);
                tint(255, currentAlpha);
                image(currentImage, 0, 0, imgW, imgH);
                pop();
            }

            // Draw next image during crossfade
            if (nextImage && phase === 'crossfade') {
                let imgRatio = nextImage.width / nextImage.height;
                let canvasRatio = width / height;
                let imgW, imgH;
                if (imgRatio > canvasRatio) {
                    imgH = height * scaleFactor;
                    imgW = imgH * imgRatio;
                } else {
                    imgW = width * scaleFactor;
                    imgH = imgW / imgRatio;
                }

                let maxPanX = (imgW - width) / 4;
                let maxPanY = (imgH - height) / 4;
                nextPanX += nextPanSpeedX;
                nextPanY += nextPanSpeedY;
                nextPanX = constrain(nextPanX, -maxPanX, maxPanX);
                nextPanY = constrain(nextPanY, -maxPanY, maxPanY);

                let x = width / 2 + nextPanX;
                let y = height / 2 + nextPanY;

               //  console.log('Draw (next): nextPanX:', nextPanX, 'nextPanY:', nextPanY, 'nextPanSpeedX:', nextPanSpeedX, 'nextPanSpeedY:', nextPanSpeedY, 'maxPanX:', maxPanX, 'maxPanY:', maxPanY);

                push();
                translate(x, y);
                imageMode(CENTER);
                tint(255, nextAlpha);
                image(nextImage, 0, 0, imgW, imgH);
                pop();
            }
        }

        function switchImage() {
            currentIndex = (currentIndex + 1);

				let wasFirstImage = isFirstImage;
				isFirstImage = false;

				if ( wasFirstImage )
				{
					imageDuration = 200;
					console.log( "***3 imageDuration to " + imageDuration );
				}
				else
				{
					imageDuration = defaultImageDuration;
					console.log( "***4 imageDuration to " + imageDuration );
				}

				if ( FAST_INTRO && isFirstImage )
				{
					imageDuration = 100; // temp
					console.log( "***4.5 imageDuration to " + imageDuration );
				}

				if (currentIndex === images.length - 1) 
				{
					isFinalImage = true;
					fadeTime = finalFadeTime;
					imageDuration = finalImageDuration;
					console.log( "***5 imageDuration to " + imageDuration );
					pauseTime = finalPauseTime;
					alphaStep = 255 / (fadeTime * 60 / 1000);
					panSpeedX = 0;
					panSpeedY = 0;
					console.log( "--8 panspeed to " + panSpeedX )

					console.log( "*********** FINAL IMAGE *********" )
					PANSPEED_SCALE = 0;
					currentPanSpeedX = 0;
					currentPanSpeedY = 0;
					nextPanSpeedX = 0;
					nextPanSpeedY = 0;
					console.log('Switching to final image with custom timing:', 
						'fadeTime:', fadeTime, 
						'imageDuration:', imageDuration, 
						'pauseTime:', pauseTime);
	            }

				if ( currentIndex === images.length - 2 )
				{
				    isSecondToLastImage = true;
					fadeTime = secondToLastFadeTime;
					imageDuration = secondToLastImageDuration;
					pauseTime = secondToLastPauseTime;
					console.log( "***6 imageDuration to " + imageDuration );
					}

				if (currentIndex >= images.length) {
                return;
            }


            currentImage = nextImage || currentImage;
            nextImage = currentIndex + 1 < images.length ? loadImage(images[currentIndex + 1]) : null;
            setNewPanDirection('current');
        }

        function setNewPanDirection(type) {
            let panAngle, panX, panY, panSpeedX, panSpeedY;
            if (type === 'current') {
                panAngle = currentPanAngle;
                panX = currentPanX;
                panY = currentPanY;
                panSpeedX = currentPanSpeedX;
                panSpeedY = currentPanSpeedY;
					 console.log( "--3 panspeed to " + panSpeedX )
            } else { // 'next'
                panAngle = nextPanAngle;
                panX = nextPanX;
                panY = nextPanY;
                panSpeedX = nextPanSpeedX;
                panSpeedY = nextPanSpeedY;
					 console.log( "--4 panspeed to " + panSpeedX )
            }

            panAngle = random(TWO_PI);
            let imgRatio = (type === 'current' ? currentImage : nextImage).width / (type === 'current' ? currentImage : nextImage).height;
            let canvasRatio = windowWidth / windowHeight;
            let imgW, imgH;
            if (imgRatio > canvasRatio) {
                imgH = windowHeight * scaleFactor;
                imgW = imgH * imgRatio;
            } else {
                imgW = windowWidth * scaleFactor;
                imgH = imgW / imgRatio;
            }
            let maxPanX = (imgW - width) / 4;
            let maxPanY = (imgH - height) / 4;
				
				let totalDisplayTime = defaultImageDuration + defaultFadeTime;
				if ( type === 'current' )
				{
				   if ( isFinalImage )
						totalDisplayTime = finalImageDuration + finalFadeTime;
					else if ( isSecondToLastImage )
						totalDisplayTime = secondToLastImageDuration + secondToLastFadeTime;
			   }

            // let totalDisplayTime = (type === 'current' && isFinalImage) ? finalImageDuration + finalFadeTime : defaultImageDuration + defaultFadeTime;
            let frames = (totalDisplayTime / 1000) * 60;
            panSpeedX = maxPanX > 0 ? (2 * maxPanX / frames) * cos(panAngle) : 0;
				console.log( "--1 panspeed to " + panSpeedX )
            panSpeedY = maxPanY > 0 ? (2 * maxPanY / frames) * sin(panAngle) : 0;
            panSpeedX *= PANSPEED_SCALE;
            panSpeedY *= PANSPEED_SCALE;
				if ( isFirstImage || isFinalImage )
				{
					panSpeedX = 0;
					panSpeedY = 0;
					console.log( "--2 panspeed to 0" )
				}
				
            panX = -maxPanX * cos(panAngle);
            panY = -maxPanY * sin(panAngle);

            if (type === 'current') {
                currentPanAngle = panAngle;
                currentPanX = panX;
                currentPanY = panY;
                currentPanSpeedX = panSpeedX;
                currentPanSpeedY = panSpeedY;
                console.log('SetNewPanDirection (current): angle:', currentPanAngle, 'speedX:', currentPanSpeedX, 'speedY:', currentPanSpeedY);
            } else { // 'next'
                nextPanAngle = panAngle;
                nextPanX = panX;
                nextPanY = panY;
                nextPanSpeedX = panSpeedX;
                nextPanSpeedY = panSpeedY;
                console.log('SetNewPanDirection (next): angle:', nextPanAngle, 'speedX:', nextPanSpeedX, 'speedY:', nextPanSpeedY);
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

		if ( NEW_AUDIO_ENABLED )
		{
			
            const audio = document.getElementById('backgroundAudio');
            const _audioFiles = ["file://d:/depots/gen_slideshow/audio/001 TALK - Afraid of the Dark (Audio).mp3","file://d:/depots/gen_slideshow/audio/002 Randy Newman - You've Got a Friend in Me (From Toy Story 4Audio Only).mp3"];
            let _audioIndex = 0;

            function playNextAudio() {
                if (_audioFiles.length > 0) {
                    audio.src = _audioFiles[_audioIndex];
                    audio.play().catch(err => console.error('Audio play error:', err));
                    audio.onended = () => {
                        _audioIndex = (_audioIndex + 1) % _audioFiles.length; // Cycle to next audio or loop back
                        playNextAudio();
                    };
                }
            }

            window.audioAPI = {
                startPlayback: () => {
                    playNextAudio();
                }
            };
        ;
		}

    </script>
</body>
</html>
        